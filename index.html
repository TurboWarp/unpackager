<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Unpackager</title>
    <style>
      :root {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color: #eee;
          background-color: #111;
          color-scheme: dark;
        }
        a {
          color: #4af;
        }
      }

      h1, h2, h3 {
        font-weight: normal;
      }

      main {
        max-width: 480px;
        margin: auto;
      }

      .warning {
        padding: 8px;
        background: yellow;
        color: black;
        border-radius: 8px;
      }

      .code {
        font-family: monospace;
      }

      input[type=file] {
        width: 100%;
      }

      .download-section a {
        display: block;
      }

      .drag-effect {
        opacity: 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border: 10px dashed rgb(110, 110, 255);
        pointer-events: none;
        transition: .2s opacity;
      }
      .dragging .drag-effect {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>Unpackager</h1>

      <p>Select or drop an HTML or zip file generated by the <a href="https://packager.turbowarp.org/">TurboWarp Packager</a>, the <a href="https://forkphorus.github.io/packager/">forkphorus packager</a>, or <a href="https://sheeptester.github.io/htmlifier/">HTMLifier</a> and this tool will try to extract the original Scratch project.</p>

      <p class="warning">The unpackager is in a very early state of development. Expect to find bugs.</p>

      <input type="file" class="file-input" accept=".zip, .html" multiple autocomplete="off">

      <p class="download-section"></p>

      <h2>Limitations</h2>
      <p>Having access to a packaged version of a project does not necessarily mean that you are legally allowed to unpackage the project, modify it, or redistribute it. We are not lawyers and will not provide legal advice on this matter.</p>
      <p>The TurboWarp Packager removes comments and script positions from packaged projects, so you may have to manually clean up the scripts.</p>

      <h2>Alternative</h2>
      <p>If the unpackager doesn't work, you can open the project in your browser and try to run this in your browser's JavaScript console:</p>
      <p class="code">
        vm.saveProjectSb3().then((blob) => {<br>
        &nbsp;&nbsp;Object.assign(document.createElement('a'), {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;href: URL.createObjectURL(blob),<br>
        &nbsp;&nbsp;&nbsp;&nbsp;download: 'Project.sb3'<br>
        &nbsp;&nbsp;}).click();<br>
        });
      </p>
      <p>It would be best that you report what file this happens on so we can fix it.</p>
      <p>This code will not work in the forkphorus packager and may have issues in recent versions of the TurboWarp Packager.</p>

      <h2>Bugs</h2>
      <p>Report bugs <a href="https://github.com/TurboWarp/unpackager/issues">on GitHub</a>.</p>

      <h2>Code</h2>
      <p>Unpackager is <a href="https://github.com/TurboWarp/unpackager">open source</a>.</p>

      <h2>Privacy</h2>
      <p>Files are processed locally on your computer and never sent to any server.</p>
    </main>

    <div class="drag-effect"></div>

    <script src="dependencies/jszip.min.js"></script>
    <script src="unpackager.js"></script>
    <script>
      (function() {
        'use strict';

        const fileInput = document.querySelector('.file-input');
        const downloadSection = document.querySelector('.download-section');

        const processFile = async (file) => {
          const unpackaged = await unpackage(file);
          const type = unpackaged.type;
          const data = unpackaged.data;
          const name = `${file.name}.${type}`;

          const blob = new Blob([data], {
            type: `application/x.scratch.${type}`
          });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = name;
          link.textContent = `Download ${name} (${(blob.size / 1000 / 1000).toFixed(2)}MB)`;
          downloadSection.appendChild(link);
          link.click();
        };

        const processInput = async () => {
          const file = fileInput.files[0];
          if (!file) {
            return;
          }

          while (downloadSection.firstChild) {
            URL.revokeObjectURL(downloadSection.firstChild.href);
            downloadSection.firstChild.remove();
          }

          try {
            for (const file of fileInput.files) {
              await processFile(file);
            }
          } catch (e) {
            console.error(e);
            alert(`An error occurred, please report this with the file you tried to unpackage.\n\n${e}`);
          }
        };

        fileInput.addEventListener('change', (e) => {
          processInput();
        });

        document.documentElement.addEventListener('drop', (e) => {
          document.documentElement.classList.remove('dragging');
          if (e.dataTransfer.types.includes('Files')) {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            processInput();
          }
        });

        document.documentElement.addEventListener('dragleave', (e) => {
          document.documentElement.classList.remove('dragging');
        });

        document.documentElement.addEventListener('dragover', (e) => {
          if (e.dataTransfer.types.includes('Files')) {
            document.documentElement.classList.add('dragging');
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
          }
        });
      }());
    </script>
  </body>
</html>
